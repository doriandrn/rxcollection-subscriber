"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_temp,_regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),_objectSpread=_interopDefault(require("@babel/runtime/helpers/objectSpread")),_toConsumableArray=_interopDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck=_interopDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass=_interopDefault(require("@babel/runtime/helpers/createClass")),_defineProperty=_interopDefault(require("@babel/runtime/helpers/defineProperty")),_applyDecoratedDescriptor=_interopDefault(require("@babel/runtime/helpers/applyDecoratedDescriptor")),_initializerWarningHelper=_interopDefault(require("@babel/runtime/helpers/initializerWarningHelper")),mobx=require("mobx"),delay=function(t){return new Promise(function(e){return setTimeout(function(){return e()},t)})},Subscriber=(_descriptor=_applyDecoratedDescriptor((_class=_temp=function(){function c(e,t){var r=this;_classCallCheck(this,c),this.collection=e,this.options=t,_defineProperty(this,"documents",[]),_defineProperty(this,"criteria",_initializerWarningHelper(_descriptor,this)),_defineProperty(this,"fetching",_initializerWarningHelper(_descriptor2,this)),_defineProperty(this,"subscribed",_initializerWarningHelper(_descriptor3,this)),_defineProperty(this,"selectedId",_initializerWarningHelper(_descriptor4,this)),_defineProperty(this,"activeId",_initializerWarningHelper(_descriptor5,this)),_defineProperty(this,"kill",function(){});var i=!0;if(t){var o=t,s=o.multipleSelect,n=o.lazy;s&&(this.selectedId=[]),n&&(i=!1)}mobx.reaction(function(){return _objectSpread({},r.criteria)},function(e){r.kill=r.subscribe(mobx.toJS(e))},{fireImmediately:i})}return _createClass(c,[{key:"ids",get:function(){return Object.keys(this.items)}},{key:"items",get:function(){return Object.assign.apply(Object,[{}].concat(_toConsumableArray(this.documents.map(function(e){return _defineProperty({},e._id,e._data)}))))}},{key:"selectedDoc",get:function(){var t=this;return this.documents.filter(function(e){return e._id===t.selectedId})[0]}},{key:"editing",get:function(){var t=this;return this.documents.filter(function(e){return e._id===t.activeId})[0]}},{key:"length",get:function(){return this.ids.length}}]),_createClass(c,[{key:"handleSubscriptionData",value:function(e){var t=this;this.subscribed||(this.subscribed=!0),this.documents=e,setTimeout(function(){t.fetching=!1},100)}},{key:"subscribeRequested",value:function(){this.fetching=!0}},{key:"subscribe",value:function(e){var t=this,r=e.limit,i=e.index,o=e.sort,s=e.filter;this.subscribeRequested();var n=this.options;r=Number(r),i=Number(i);var c=n&&n.progressivePaging?r+r*i:r;return this.collection.find(s).limit(c).sort(mobx.toJS(o)).$.subscribe(function(e){return t.handleSubscriptionData(e)}).unsubscribe}},{key:"select",value:function(e){"string"!=typeof this.selectedId&&this.selectedId&&this.options&&this.options.multipleSelect?this.selectedId.indexOf(e)<0?this.selectedId.push(e):this.selectedId.splice(this.selectedId.indexOf(e),1):this.selectedId=e}},{key:"edit",value:function(e){this.activeId=e}},{key:"updates",get:function(){var e=this;return new Promise(function(r){mobx.reaction(function(){return e.fetching},function(){var t=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,delay(50);case 3:r();case 4:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}())})}}]),c}()).prototype,"criteria",[mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{limit:25,index:0,sort:{},filter:void 0}}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"fetching",[mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"subscribed",[mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"selectedId",[mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"activeId",[mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_applyDecoratedDescriptor(_class.prototype,"ids",[mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"ids"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"items",[mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"items"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"selectedDoc",[mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"selectedDoc"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"editing",[mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"editing"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"length",[mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"length"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"handleSubscriptionData",[mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"handleSubscriptionData"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"subscribeRequested",[mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"subscribeRequested"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"select",[mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"select"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"edit",[mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"edit"),_class.prototype),_class);module.exports=Subscriber;
