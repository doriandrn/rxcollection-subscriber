"use strict";var mobx=require("mobx");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function __decorate(e,t,r,i){var n,o=arguments.length,c=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;0<=s;s--)(n=e[s])&&(c=(o<3?n(c):3<o?n(t,r,c):n(t,r))||c);return 3<o&&c&&Object.defineProperty(t,r,c),c}function __awaiter(o,c,s,u){return new(s||(s=Promise))(function(e,t){function r(e){try{n(u.next(e))}catch(e){t(e)}}function i(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,i)}n((u=u.apply(o,c||[])).next())})}var delay=function(t){return new Promise(function(e){return setTimeout(function(){return e()},t)})},Subscriber=function(){function c(e,t){var r=this;_classCallCheck(this,c),this.collection=e,this.options=t,this.documents=[],this.criteria={limit:25,index:0,sort:{},filter:void 0},this.fetching=!1,this.subscribed=!1,this.kill=function(){};var i=!0;if(t){var n=t.multipleSelect,o=t.lazy;n&&(this.selectedId=[]),o&&(i=!1)}mobx.reaction(function(){return Object.assign({},r.criteria)},function(e){r.kill=r.subscribe(mobx.toJS(e))},{fireImmediately:i})}return _createClass(c,[{key:"handleSubscriptionData",value:function(e){var t=this;this.subscribed||(this.subscribed=!0),this.documents=e,setTimeout(function(){t.fetching=!1},100)}},{key:"subscribeRequested",value:function(){this.fetching=!0}},{key:"subscribe",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:mobx.toJS(this.criteria),r=e.limit,i=e.index,n=e.sort,o=e.filter;this.subscribeRequested();var c=this.options;r=Number(r),i=Number(i);var s=c&&c.progressivePaging?r+r*i:r;return this.collection.find(o).limit(s).sort(mobx.toJS(n)).$.subscribe(function(e){return t.handleSubscriptionData(e)}).unsubscribe}},{key:"select",value:function(e){"string"!=typeof this.selectedId&&this.selectedId&&this.options&&this.options.multipleSelect?this.selectedId.indexOf(e)<0?this.selectedId.push(e):this.selectedId.splice(this.selectedId.indexOf(e),1):this.selectedId=e}},{key:"edit",value:function(e){this.activeId=e}},{key:"ids",get:function(){return Object.keys(this.items)}},{key:"items",get:function(){return Object.assign.apply(Object,[{}].concat(_toConsumableArray(this.documents.map(function(e){return _defineProperty({},e._id,e._data)}))))}},{key:"selectedDoc",get:function(){var t=this;return this.documents.filter(function(e){return e._id===t.selectedId})[0]}},{key:"editing",get:function(){var t=this;return this.documents.filter(function(e){return e._id===t.activeId})[0]}},{key:"length",get:function(){return this.ids.length}},{key:"updates",get:function(){var e=this;return new Promise(function(r){mobx.reaction(function(){return e.fetching},function(t){return __awaiter(e,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,delay(50);case 3:r();case 4:case"end":return e.stop()}},e,this)}))})})}}]),c}();__decorate([mobx.observable],Subscriber.prototype,"criteria",void 0),__decorate([mobx.observable],Subscriber.prototype,"fetching",void 0),__decorate([mobx.observable],Subscriber.prototype,"subscribed",void 0),__decorate([mobx.observable],Subscriber.prototype,"selectedId",void 0),__decorate([mobx.observable],Subscriber.prototype,"activeId",void 0),__decorate([mobx.computed],Subscriber.prototype,"ids",null),__decorate([mobx.computed],Subscriber.prototype,"items",null),__decorate([mobx.computed],Subscriber.prototype,"selectedDoc",null),__decorate([mobx.computed],Subscriber.prototype,"editing",null),__decorate([mobx.computed],Subscriber.prototype,"length",null),__decorate([mobx.action],Subscriber.prototype,"handleSubscriptionData",null),__decorate([mobx.action],Subscriber.prototype,"subscribeRequested",null),__decorate([mobx.action],Subscriber.prototype,"select",null),__decorate([mobx.action],Subscriber.prototype,"edit",null),module.exports=Subscriber;
