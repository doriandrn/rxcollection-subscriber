"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function __decorate(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;0<=c;c--)(i=e[c])&&(a=(o<3?i(a):3<o?i(t,r,a):i(t,r))||a);return 3<o&&a&&Object.defineProperty(t,r,a),a}function __awaiter(e,a,c,s){return new(c=c||Promise)(function(r,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function i(e){try{o(s.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(n,i)}o((s=s.apply(e,a||[])).next())})}var defaultMessages={emptyState:"None",multipleSelected:"%s selected",deselectAll:"Clear",noResults:"No results matching selected criteria",filters:{new:"Add filter",trash:"Remove filter",disable:"Disable filter",enable:"Enable filter",connectors:{or:"Or",nor:"Nor",and:"And"}}};function render(_){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function e(){var t,d,a,u,n,r,i,f,p,c,o,s,l,m,b,h,y,v,g=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(document){e.next=2;break}throw new Error("Render function only works in browser so far.");case 2:if(t=_.selector,d=_.mapRefFields,a=document.querySelector(t)){e.next=6;break}throw new Error("Could not find selector ".concat(t));case 6:if(u=Object.assign({},Object.assign({},defaultMessages),Object.assign({},_.messages)),n=_&&!1!==_.persistState,r=this.collection.schema,i=r.indexes,f=r.jsonSchema.properties,p=Object.keys(f).filter(function(e){return 0!==e.indexOf("_")}),c=document.createElement("li"),a.dataset.sub=_.name||this.collection.name,a.dataset.ctx=_.context||"main",o="".concat(this.collection.database.name,"-").concat(a.dataset.ctx,"-").concat(a.dataset.sub),s={},mobx.reaction(function(){return Object.assign({},g.items)},function(o){return __awaiter(g,void 0,void 0,regeneratorRuntime.mark(function e(){var t,r,n,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.ids,r="",a.classList.add("fetching"),t.length)return e.next=6,Promise.all(t.map(function(u,e){return __awaiter(i,void 0,void 0,regeneratorRuntime.mark(function e(){var l,t,r,n,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return l=o[u],t=_&&_.asTable?p:Object.keys(l),e.t0=Array,e.next=5,Promise.all(t.filter(function(e){return 0!==e.indexOf("_")}).sort(function(e,t){return p.indexOf(e)-p.indexOf(t)}).map(function(c,s){return __awaiter(i,void 0,void 0,regeneratorRuntime.mark(function e(){var t,r,n,i,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=0===s?"strong":"span",!d||!d[c]){e.next=11;break}if(-1<Object.keys(d).indexOf(c))return n=d[c].split("."),i=l._doc,e.next=7,i["".concat(n[0],"_")];e.next=9;break;case 7:(o=e.sent)&&(r=-1<o.length?o.map(function(e){if(e)return a=a||e.collection.schema.jsonSchema.title,'<a href="#detail?'.concat(a,"=").concat(u,'">').concat(e[n[1]],"</a>")}).join(""):'<a href="#detail?'.concat(o.collection.schema.jsonSchema.title,"=").concat(u,'">').concat(o[n[1]],"</a>"));case 9:e.next=12;break;case 11:r=l[c];case 12:return"string"==typeof r&&r.indexOf(".jpg")===r.length-4&&(t="figure",r='<img src="'.concat(r,'" />')),e.abrupt("return","<".concat(t,">").concat(r||"-","</").concat(t,">"));case 14:case"end":return e.stop()}},e)}))}));case 5:return e.t1=e.sent,r=e.t0.from.call(e.t0,e.t1).join(""),n=this.selectedId&&-1<this.selectedId.indexOf(u),e.abrupt("return",'<li data-id="'.concat(u,'" class="').concat(n?"sel":"",'">').concat(r,"</li>"));case 9:case"end":return e.stop()}},e,this)}))}));e.next=14;break;case 6:r=e.sent,v.innerHTML="".concat(Array.from(r).join("")),_.asTable&&v.prepend(c),a.querySelector(".items")||a.append(v),(n=a.querySelector("p.empty"))&&n.remove(),e.next=15;break;case 14:a.innerHTML=a.innerHTML+'<p class="empty">'.concat(u.emptyState,"</p>");case 15:a.classList.remove("fetching");case 16:case"end":return e.stop()}},e,this)}))},{fireImmediately:!0}),mobx.reaction(function(){return"object"===_typeof(g.selectedId)?_toConsumableArray(g.selectedId):g.selectedId},function(e){var t,r=g.selectedId;l&&"object"===_typeof(r)&&(t=r.length,l.innerHTML=t?u.multipleSelected.replace("%s","<strong>".concat(t,"</strong>"))+"; <a>".concat(u.deselectAll,"</a>"):""),n&&localStorage.setItem(o,JSON.stringify(Object.assign({},s,{selectedId:r})))}),_.controls&&(m={limit:{type:"number"},filter:{type:"text"}},b=document.createElement("div"),l=document.createElement("span"),b.classList.add("controls"),b.append(l),a.querySelector(".controls")||a.prepend(b),Object.keys(m).map(function(t){var r=document.createElement("span"),e=document.createElement("label");switch(e.textContent=String(t).toUpperCase(),t){case"limit":var n=document.createElement("input");n.type=m[t].type,n.value=g.criteria[t],n.addEventListener("change",function(e){g.criteria[t]=e.target.value}),r.append(n);break;case"filter":var s=document.createElement("button");s.textContent=u.filters.new;document.createElement("select");var i=document.createElement("select"),o=document.createElement("select"),a=document.createElement("input");p.map(function(e){var t=document.createElement("option");t.value=e,t.textContent=e,i.append(t)}),i.name="field";var l=document.createElement("div");l.append(i,o,a);var c=function(){var o=document.createElement("span"),e=document.createElement("button");o.classList.add("filter"),o.append(e),e.textContent=u.filters.trash;var i,a,n=l.cloneNode(!0),c=Array.prototype.indexOf.call(r,n);n.addEventListener("filterUpdated",function(e){var t=e.detail,r=o.children[t+1];console.log("x",t,r);var n=Array.from(r.children).map(function(e){return e.value}),i=!0;n.forEach(function(e){e||(i=!1)}),console.log(n,i),i&&(s.disabled=!1)}),Array.from(n.children).forEach(function(e,t){var r=new CustomEvent("filterUpdated",{detail:c});e.addEventListener("change",function(){n.dispatchEvent(r)})}),n.children[0].addEventListener("change",(i=n.children[1],a=n.children[2],function(e){var t=e.target.value,r=f[t].type;a.setAttribute("type","number"===r?"number":"text"),a.value=null;var n="number"===r?{lt:"<",lte:"<=",gt:">",gte:">=",eq:"="}:{in:"contains",nin:"does not contain",regex:"RegEx"};i.innerHTML="",Object.keys(n).map(function(e){var t=document.createElement("option");t.value=e,t.textContent=n[e],i.append(t)})})),o.prepend(n),e.addEventListener("click",function(){o.remove(),s.disabled=!1}),r.append(o)};s.addEventListener("click",function(e){c(),e.target.disabled=!0}),r.append(s)}r.append(e),b.append(r)})),n&&_.holder){try{s=JSON.parse(localStorage.getItem(o))}catch(e){console.log("wtf json parse")}s&&(h=s.selectedId,y=s.criteria,h&&this.select(h),y&&(this.criteria=Object.assign({},y)))}p.map(function(t){var e=i.length&&i.filter(function(e){return-1<e.indexOf(t)}).length,r=document.createElement("span");r.textContent=t,e&&(r.classList.add("sortable"),r.addEventListener("click",function(){var e=Number(!g.criteria.sort[t]);g.criteria.sort=_defineProperty({},t,e),r.dataset.dir=e})),c.append(r)}),(v=document.createElement("ol")).start=0,_.asTable&&v.classList.add("table"),n&&mobx.reaction(function(){return Object.assign({},g.criteria)},function(e){localStorage.setItem(o,JSON.stringify(Object.assign({},s,{criteria:e})))});case 24:case"end":return e.stop()}},e,this)}))}var Subscriber=function(){function u(e,t){var r=this;_classCallCheck(this,u),this.collection=e,this.options=t,this.documents=[],this.criteria={limit:25,index:0,sort:{},filter:void 0},this.fetching=!1,this.subscribed=!1,this.selectedId="",this.name="unnamed",this.context="main",this.fields="all",this.render=function(){},this.kill=function(){};var n,i,o,a,c,s,l=!0;this.kill=function(){},t&&(n=t.multipleSelect,i=t.lazy,o=t.criteria,a=t.fields,c=t.name,s=t.context,n&&(this.selectedId=[]),i&&(l=!1),o&&Object.keys(o).forEach(function(e){return r.criteria[e]=o[e]}),a&&(this.fields=a),c&&(this.name=c),s&&(this.context=s)),mobx.reaction(function(){return Object.assign({},r.criteria)},function(){return __awaiter(r,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribe();case 2:this.kill=e.sent;case 3:case"end":return e.stop()}},e,this)}))},{fireImmediately:l}),this.render=render.bind(this)}return _createClass(u,[{key:"subscribe",value:function(){var t=this;return this.fetching=!0,this.collection.find({selector:this.filter||{}}).limit(this.paging).sort(mobx.toJS(this.criteria.sort)).$.subscribe(function(e){t.documents=e,t.fetching=!1,t.subscribed||(t.subscribed=!0)}),this.collection.destroy.bind(this.collection)}},{key:"select",value:function(e){var t,r=this;"string"!=typeof this.selectedId&&this.selectedId&&this.options&&this.options.multipleSelect?(t=function e(t){"string"==typeof t?r.selectedId.indexOf(t)<0?r.selectedId.push(t):r.selectedId.splice(r.selectedId.indexOf(t),1):t.length&&t.map(e)},t(e)):this.selectedId=e!==String(this.selectedId)?e:""}},{key:"edit",value:function(e){this.activeId=e}},{key:"ids",get:function(){return Object.keys(this.items)}},{key:"items",get:function(){var e=this,r=this.fields;return Object.assign.apply(Object,[{}].concat(_toConsumableArray(this.documents.map(function(t){return _defineProperty({},t[e.primaryPath],Object.assign({},r&&"all"!==r?Object.fromEntries(r.map(function(e){return[e,t[e]]})):t._data,{_doc:t}))}))))}},{key:"selectedDoc",get:function(){var t=this;return this.documents.filter(function(e){return e[t.primaryPath]===t.selectedId})[0]}},{key:"editing",get:function(){var t=this;return this.documents.filter(function(e){return e[t.primaryPath]===t.activeId})[0]}},{key:"length",get:function(){return this.ids.length}},{key:"primaryPath",get:function(){return this.collection.schema.primaryPath||"_id"}},{key:"filter",get:function(){return this.criteria.filter}},{key:"paging",get:function(){var e=this.options,t=Number(this.criteria.limit),r=Number(this.criteria.index);return e&&e.progressivePaging?t+t*r:t}},{key:"updates",get:function(){var e=this;return new Promise(function(r){mobx.reaction(function(){return e.fetching},function(t){return __awaiter(e,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,this.collection.database.requestIdlePromise();case 3:r();case 4:case"end":return e.stop()}},e,this)}))})})}}]),u}();__decorate([mobx.observable],Subscriber.prototype,"documents",void 0),__decorate([mobx.observable],Subscriber.prototype,"criteria",void 0),__decorate([mobx.observable],Subscriber.prototype,"fetching",void 0),__decorate([mobx.observable],Subscriber.prototype,"subscribed",void 0),__decorate([mobx.observable],Subscriber.prototype,"selectedId",void 0),__decorate([mobx.observable],Subscriber.prototype,"activeId",void 0),__decorate([mobx.computed],Subscriber.prototype,"ids",null),__decorate([mobx.computed],Subscriber.prototype,"items",null),__decorate([mobx.computed],Subscriber.prototype,"selectedDoc",null),__decorate([mobx.computed],Subscriber.prototype,"editing",null),__decorate([mobx.computed],Subscriber.prototype,"length",null),__decorate([mobx.computed],Subscriber.prototype,"filter",null),__decorate([mobx.computed],Subscriber.prototype,"paging",null),__decorate([mobx.action],Subscriber.prototype,"select",null),__decorate([mobx.action],Subscriber.prototype,"edit",null),module.exports=Subscriber;
